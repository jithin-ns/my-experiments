Hereâ€™s a clear, professional, and security-reviewer-ready explanation of how Azure Entra authentication, tokens, scopes, roles, and API authorization should work together, with references to Microsoft documentation.


---

âœ… 1. Token Types & Their Purpose

ðŸ”¹ ID Token

Used to authenticate the user to the client application (FE).

Contains information about the user (claims like oid, name, preferred_username).

Not intended for authorizing API calls. Use it to identify the user in the UI, not for backend enforcement.

Microsoft Docs: ID Token is for authentication. 


ðŸ”¹ Access Token

Used to access protected APIs (backend services or Microsoft Graph).

Contains the essential claims the API trusts for authorization (scope scp, optional roles roles, aud, oid).

API must validate this token. Clients should NEVER validate it. 

Backend must verify signature, issuer, audience, expiration, etc., and then check scopes/roles to authorize requests.



---

âœ… 2. Frontend (FE) Configurations & Audience (aud)

What determines the aud claim?

The aud in the access token must be the identifier of the resource being accessed (your backend API):

This is usually the Application ID URI you set for the backend app (e.g., api://<backend-client-id>).

If the FE requests a token with this audience, Azure Entra issues a token with aud == backend.

Otherwise, tokens meant for MS Graph will have aud == Graph and wonâ€™t work for your backend.


FE must request an access token like:

const tokenResponse = await msalInstance.acquireTokenSilent({
  scopes: ["api://<backend-client-id>/rules.save-to-live"]
});

This ensures the access tokenâ€™s aud is your backend API. 

Application ID URI

This is for the backend API.

Example: api://<backend-client-id> â†’ then add scopes under this API. 



---

âœ… 3. Do You Need a Separate App Registration for BE?

Yes â€” best practice:

Frontend App Registration â†’ Represents the client SPA.

Backend App Registration â†’ Represents the protected API.


This separation allows proper issuance and validation of tokens, audience scopes, and access control. 


---

âœ… 4. User Must Be Authorized to Access the BE App?

Yes â€” but this depends on settings:

If the backend app is configured with â€œUser assignment requiredâ€, then the user must be assigned to it (or through a group/app role). 

If not, just requesting consent for the scopes and having permission may be enough.


This is why your earlier invalid_grant occurred â€” user wasnâ€™t assigned or consented to required permissions.


---

âœ… 5. Your Current UI Token Acquisition Flow

Letâ€™s analyze your proposed sequence and confirm it:

âœ” UI authenticates user using MSAL.
âœ” FE requests access token for backend API using backend scope.
âœ” FE requests access token for Graph API using "User.Read".
âœ” FE sends API token with each API request.

âž¡ï¸ This is fundamentally correct â€” each API call from FE should carry a bearer token that has the correct audience and scope for that API. 

Important: The access token for backend and Graph must be separate tokens, because they have different audiences.


---

âœ… 6. What Does ap://guid/.default Mean?

/.default is a shortcut scope that indicates all statically defined delegated scopes granted to the app.

It doesnâ€™t dynamically filter based on roles.

If your backend API has multiple scopes, asking for .default can return all of them if consent has been given. 


âš  This does not yield selective scopes based on role â€” itâ€™s just a convenience to get all previously consented scopes.


---

âœ… 7. Scopes vs. Roles

Scopes

Represent permissions for APIs that the client app can ask for on behalf of the user.

They are delegated permissions: the API receives a token that indicates what operations the user allowed. 


App Roles

Represent role-based permissions defined within the API itself.

If configured, Azure Entra includes them in the roles claim of the access token if the user is assigned to those roles. 



---

âœ… 8. Should UI Restrict API Call Based on Scopes?

Yes, ideally both layers should enforce checks:

UI: Hide unauthorized features based on tokenâ€™s scopes/roles â†’ improves UX.

API: Must enforce server-side authorization based on scopes/roles in the token â†’ security boundary.


UI checks help UX but are not sufficient for security.


---

âœ… 9. How Should Backend Restrict Access Using Scopes?

On each API endpoint:

1. Validate access token:

Signature

aud equals your backend API

iss, expiry, etc.



2. Check claims:

scp for required scope (like rules.save-to-live)

or roles if role-based access is used




Example (pseudocode):

if (!token.scp.includes("scope.api1")) {
  return 403 Forbidden
}

âž¡ï¸ Backend enforces least privilege based on token claims. 


---

âœ… 10. Role vs. Scope for Authorization

Role in token:

More static; represents userâ€™s role assignment (e.g., Admin, Manager).

Issued when configured in API registration â†’ client app and user assigned roles. 


Scope:

Represents permission to call specific API functionality.


Best practice for API:

Use scopes for coarse-grained API access

Use roles or groups for fine-grained authorization (e.g., Admin vs Basic User)



---

ðŸ“Œ Summary for Cyber/Security Reviewers (Copy-Paste)

> Design Overview â€” Azure Entra ID Authentication & Authorization (OAuth2 + OIDC)

â€¢ Frontend obtains ID Token (for UI authentication) and Access Tokens (for API calls).
â€¢ Access Tokens carry the aud (audience) equal to the APIâ€™s Application ID URI (e.g., api://<backend-id>).
â€¢ Each protected resource defines scopes; backend validates the token and checks required scopes.
â€¢ App roles can be defined and included in access tokens for role-based authorization when necessary.
â€¢ The backend must validate tokens (signature & claims) and enforce access control based on scopes and/or roles â€” UI checks alone are insufficient.
â€¢ The Azure Entra ID issues tokens based on scope consent; .default is a special scope for all granted scopes, not filtered by role.
â€¢ Token validation and authorization logic should follow Microsoftâ€™s recommended patterns for Protected Web APIs. 




---

ðŸ“Œ Useful Microsoft Documentation Links

ðŸ”— Access Tokens overview â€” https://learn.microsoft.com/entra/identity-platform/access-tokens 
ðŸ”— Scopes & permissions â€” https://learn.microsoft.com/entra/identity-platform/scopes-oidc 
ðŸ”— Expose API & scopes setup â€” https://learn.microsoft.com/entra/identity-platform/quickstart-configure-app-expose-web-apis 
ðŸ”— Protect Web API (verify scopes/roles) â€” https://learn.microsoft.com/entra/identity-platform/scenario-protected-web-api-verification-scope-app-roles 
ðŸ”— Configure group claims & app roles â€” https://learn.microsoft.com/security/zero-trust/develop/configure-tokens-group-claims-app-roles 


---

If you want, I can turn this into an email-ready (or Confluence-ready) formatted document for your reviewers.
