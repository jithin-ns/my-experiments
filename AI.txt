Your problem is mostly syntax + how GitHub Actions handles environment secrets + how Vite reads env vars. There are a few critical issues:


---

‚úÖ 1. Fix the workflow syntax

Your YAML has formatting errors. Here‚Äôs a cleaned and corrected version of your workflow that will actually inject environment secrets:

name: build the app artifact

on:
  workflow_call:
    inputs:
      env:
        type: string
        required: true
        default: dev

jobs:
  build:
    name: Build React App
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}

    outputs:
      artifact-name: react-build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Configure npm for GitHub Packages
        run: |
          echo "@britishairways-ent:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
          echo "registry=https://registry.npmjs.org/" >> .npmrc
          echo "always-auth=true" >> .npmrc

      - name: Install dependencies
        env:
          VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          VITE_ENTRA_CLIENT_ID: ${{ secrets.ENTRA_CLIENT_ID }}
          VITE_ENTRA_TENANT_ID: ${{ secrets.ENTRA_TENANT_ID }}
          VITE_ENV_NAME: ${{ secrets.ENV_NAME }}
        run: npm ci

      - name: Build React app
        env:
          VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}
          VITE_ENTRA_CLIENT_ID: ${{ secrets.ENTRA_CLIENT_ID }}
          VITE_ENTRA_TENANT_ID: ${{ secrets.ENTRA_TENANT_ID }}
          VITE_ENV_NAME: ${{ secrets.ENV_NAME }}
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: react-build
          path: dist


---

‚úÖ 2. Your main mistake: exporting env vars inside run

This part is the core issue:

export VITE_API_BASE_URL="..."

Each GitHub Actions step runs in a separate shell.

üëâ Exporting variables inside run only works within that step, not the next one.

Since Vite needs env vars during build, they must be available in the build step.


---

‚úÖ 3. Correct way: use env: block

This is the most reliable approach:

- name: Build React app
  env:
    VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}
  run: npm run build

GitHub injects them properly into the process environment.


---

‚úÖ 4. Secret naming rules (very important)

GitHub secrets:

‚ùå Cannot contain spaces
‚úÖ Must use underscores

So these are invalid:

API BASE URL
ENTRA CLIENT ID

They must be:

API_BASE_URL
ENTRA_CLIENT_ID
ENTRA_TENANT_ID
ENV_NAME

Go to:

üëâ Settings ‚Üí Environments ‚Üí dev ‚Üí Secrets

Rename them accordingly.


---

‚úÖ 5. Vite requirement: must start with VITE_

You already did this right üëç

Vite only exposes env vars prefixed with:

VITE_

In your React code:

import.meta.env.VITE_API_BASE_URL


---

‚úÖ 6. Optional improvement: set env once for entire job

Instead of repeating in each step:

jobs:
  build:
    env:
      VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}
      VITE_ENTRA_CLIENT_ID: ${{ secrets.ENTRA_CLIENT_ID }}

Then all steps inherit it.


---

üö® Quick checklist

Make sure all of these are true:

‚úî Secrets have no spaces in names
‚úî Using env: not export
‚úî Build step has env variables
‚úî Environment name matches GitHub environment
‚úî Secrets exist inside that environment
‚úî Variables start with VITE_
‚úî YAML indentation is correct


---

If you want, paste your GitHub logs error message, and I can pinpoint exactly where it‚Äôs failing.
